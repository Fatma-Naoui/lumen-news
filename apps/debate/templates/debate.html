<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debate - Real-time Streaming</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .input-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
        }
        
        button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1e3c72;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected { background: #4CAF50; }
        .status-indicator.streaming { background: #2196F3; }
        .status-indicator.error { background: #f44336; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .debate-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .round-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .agent-response {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .agent-response.defender {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .agent-response.opposer {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .agent-response.judge {
            background: #f3e5f5;
            border-color: #9c27b0;
        }
        
        .agent-label {
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        
        .agent-label.defender { color: #1976D2; }
        .agent-label.opposer { color: #F57C00; }
        .agent-label.judge { color: #7B1FA2; }
        
        .agent-content {
            line-height: 1.6;
            color: #333;
        }
        
        .verdict-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .verdict-score {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .typing-indicator {
            display: inline-block;
            animation: blink 1.4s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ AI Debate Arena</h1>
        
        <div class="input-section">
            <h3>Article to Debate</h3>
            <textarea id="articleInput" placeholder="Paste article text here...">Source: The Guardian
Headline: Israel will disarm Hamas and demilitarise Gaza, says Netanyahu

Israel's prime minister has said the country will maintain security control over Gaza for an indefinite period after the war, and that the Palestinian enclave will be demilitarised.</textarea>
            <button id="startBtn" onclick="startDebate()">Start Debate</button>
        </div>
        
        <div class="status" id="status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Ready to start</span>
        </div>
        
        <div id="debateContent"></div>
    </div>

    <script>
        let eventSource = null;
        let currentRound = 0;
        let currentAgent = null;
        let tokenCount = 0;
        let startTime = null;

        function startDebate() {
            const article = document.getElementById('articleInput').value;
            const startBtn = document.getElementById('startBtn');
            const debateContent = document.getElementById('debateContent');
            
            // Reset UI
            debateContent.innerHTML = '';
            currentRound = 0;
            currentAgent = null;
            tokenCount = 0;
            startTime = Date.now();
            
            // Disable button
            startBtn.disabled = true;
            startBtn.textContent = 'Debate in progress...';
            
            updateStatus('streaming', 'Connecting to debate stream...');
            
            // Close existing connection
            if (eventSource) {
                eventSource.close();
            }
            
            // Create new SSE connection
            const url = `/debate/stream/?article=${encodeURIComponent(article)}`;
            eventSource = new EventSource(url);
            
            eventSource.onopen = () => {
                console.log('‚úÖ SSE connection opened');
                updateStatus('connected', 'Connected - waiting for debate to start...');
            };
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì® Event:', data.type, data);
                
                handleEvent(data);
            };
            
            eventSource.onerror = (error) => {
                console.error('‚ùå SSE error:', error);
                updateStatus('error', 'Connection error - retrying...');
                
                setTimeout(() => {
                    if (eventSource.readyState === EventSource.CLOSED) {
                        eventSource.close();
                        startBtn.disabled = false;
                        startBtn.textContent = 'Start Debate';
                        updateStatus('error', 'Connection lost. Please try again.');
                    }
                }, 3000);
            };
        }
        
        function handleEvent(data) {
            switch(data.type) {
                case 'connected':
                    updateStatus('connected', 'Connected successfully');
                    break;
                    
                case 'agent_start':
                    currentAgent = data.agent;
                    currentRound = data.round;
                    
                    console.log(`üéØ Agent started: ${data.agent} - Round ${data.round}`);
                    
                    updateStatus('streaming', `Round ${data.round}: ${data.agent} is speaking...`);
                    
                    // Create container for this agent's response
                    ensureAgentContainer(data.agent, data.round);
                    break;
                    
                case 'token':
                    if (data.token) {
                        tokenCount++;
                        appendToken(data.agent, data.round, data.token);
                        
                        // Update status with token count
                        updateStatus('streaming', 
                            `Round ${data.round || '?'}: ${data.agent || 'unknown'} speaking... (${tokenCount} tokens)`
                        );
                    }
                    break;
                    
                case 'complete':
                    console.log('‚úÖ Debate complete!');
                    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                    updateStatus('connected', `Debate completed! (${duration}s, ${tokenCount} tokens)`);
                    
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('startBtn').textContent = 'Start New Debate';
                    
                    eventSource.close();
                    break;
                    
                case 'error':
                    console.error('‚ùå Error:', data.message);
                    updateStatus('error', `Error: ${data.message}`);
                    
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('startBtn').textContent = 'Start Debate';
                    
                    eventSource.close();
                    break;
            }
        }
        
        function ensureAgentContainer(agent, round) {
            const containerId = `${agent}-round${round}`;
            
            if (document.getElementById(containerId)) {
                return; // Already exists
            }
            
            const debateContent = document.getElementById('debateContent');
            
            // Create round header if needed
            const roundId = `round-${round}`;
            if (!document.getElementById(roundId)) {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'debate-section';
                roundDiv.id = roundId;
                roundDiv.innerHTML = `<div class="round-header">Round ${round}</div>`;
                debateContent.appendChild(roundDiv);
            }
            
            // Create agent response container
            const agentDiv = document.createElement('div');
            agentDiv.className = `agent-response ${agent}`;
            agentDiv.id = containerId;
            agentDiv.innerHTML = `
                <div class="agent-label ${agent}">${agent.toUpperCase()}</div>
                <div class="agent-content" id="${containerId}-content">
                    <span class="typing-indicator">‚ñä</span>
                </div>
            `;
            
            document.getElementById(roundId).appendChild(agentDiv);
        }
        
        function appendToken(agent, round, token) {
            const containerId = `${agent}-round${round}-content`;
            const container = document.getElementById(containerId);
            
            if (container) {
                // Remove typing indicator if present
                const indicator = container.querySelector('.typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
                
                // Append token
                container.textContent += token;
                
                // Auto-scroll to bottom
                container.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }
        
        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = `status-indicator ${type}`;
            text.textContent = message;
        }
    </script>
</body>
</html>